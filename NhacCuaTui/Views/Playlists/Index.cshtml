@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>🎧 Playlist của bạn</h2>
        <div>
            <button id="createPlaylistBtn" class="btn btn-primary">+ Tạo playlist mới</button>
        </div>
    </div>

    <div id="playlistsContainer" class="row">
        <!-- Playlists will be loaded here -->
    </div>

    <div id="emptyState" style="display:none;" class="alert alert-info">Bạn chưa có playlist nào. Tạo playlist đầu tiên ngay!</div>
</div>

<!-- Floating Player -->
<div id="floatingPlayer" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#fff; box-shadow:0 -2px 10px rgba(0,0,0,0.08); z-index:1050; padding:10px 20px;">
    <div class="container d-flex align-items-center">
        <div style="width:60px; height:60px; overflow:hidden; border-radius:6px; background:#f1f1f1; display:flex; align-items:center; justify-content:center;">
            <img id="fp-thumbnail" src="" style="width:100%; height:100%; object-fit:cover; display:none;" />
            <i id="fp-placeholder" class="fas fa-music fa-2x text-muted"></i>
        </div>
        <div class="ml-3 flex-grow-1">
            <div id="fp-title" style="font-weight:600;">-</div>
            <div id="fp-artist" class="text-muted" style="font-size:0.9rem;">-</div>
            <div class="progress mt-2" style="height:6px;">
                <div id="fp-progress" class="progress-bar" role="progressbar" style="width:0%;"></div>
            </div>
        </div>
        <div class="ml-3 d-flex align-items-center">
            <button id="fp-prev" class="btn btn-sm btn-light mr-1"><i class="fas fa-step-backward"></i></button>
            <button id="fp-play" class="btn btn-sm btn-primary mr-1"><i class="fas fa-play"></i></button>
            <button id="fp-next" class="btn btn-sm btn-light mr-2"><i class="fas fa-step-forward"></i></button>
            <button id="fp-close" class="btn btn-sm btn-outline-secondary">Đóng</button>
        </div>
    </div>
    <audio id="fp-audio"></audio>
</div>

<style>
    .playlist-card { cursor: pointer; transition: transform .12s ease, box-shadow .12s ease; }
    .playlist-card:hover { transform: translateY(-4px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
</style>

<script>
    const playlistsContainer = document.getElementById('playlistsContainer');
    const emptyState = document.getElementById('emptyState');
    const floatingPlayer = document.getElementById('floatingPlayer');
    const audioEl = document.getElementById('fp-audio');
    const fpTitle = document.getElementById('fp-title');
    const fpArtist = document.getElementById('fp-artist');
    const fpThumbnail = document.getElementById('fp-thumbnail');
    const fpPlaceholder = document.getElementById('fp-placeholder');
    const fpPlayBtn = document.getElementById('fp-play');
    const fpPrevBtn = document.getElementById('fp-prev');
    const fpNextBtn = document.getElementById('fp-next');
    const fpCloseBtn = document.getElementById('fp-close');
    const fpProgress = document.getElementById('fp-progress');

    let currentPlaylist = [];
    let currentIndex = 0;
    let isPlaying = false;

    function fetchUserPlaylists() {
        fetch('/Playlists/GetUserPlaylists?songId=0')
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    playlistsContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning">' + (data.message || 'Vui lòng đăng nhập để quản lý playlist.') + '</div></div>';
                    return;
                }
                const pls = data.playlists || [];
                if (pls.length === 0) {
                    emptyState.style.display = 'block';
                    playlistsContainer.innerHTML = '';
                    return;
                }
                emptyState.style.display = 'none';
                playlistsContainer.innerHTML = '';
                pls.forEach(p => renderPlaylistCard(p));
            })
            .catch(err => {
                playlistsContainer.innerHTML = '<div class="col-12"><div class="alert alert-danger">Không thể tải playlist.</div></div>';
                console.error(err);
            });
    }

    function renderPlaylistCard(p) {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        col.innerHTML = `
            <div class="card playlist-card">
                <div class="card-body">
                    <h5 class="card-title">${escapeHtml(p.name)}</h5>
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="playPlaylist(${p.id}, '${escapeJs(p.name)}')">▶ Nghe</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="openPlaylist(${p.id})">Xem</button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deletePlaylist(${p.id})">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        playlistsContainer.appendChild(col);
    }

    function playPlaylist(playlistId, playlistName) {
        fetch(`/Playlists/GetSongsInPlaylist?playlistId=${playlistId}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) { alert(data.message || 'Không thể lấy danh sách bài hát.'); return; }
                currentPlaylist = data.songs || [];
                if (currentPlaylist.length === 0) { alert('Playlist trống.'); return; }
                currentIndex = 0;
                showPlayer();
                loadTrack(currentIndex);
                playAudio();
            })
            .catch(err => { console.error(err); alert('Lỗi khi tải playlist'); });
    }

    function openPlaylist(playlistId) {
        // Redirect to a playlist detail page (not implemented) — as fallback, open Playlists/Index with query
        window.location.href = `/Playlists/Index?playlistId=${playlistId}`;
    }

    function deletePlaylist(playlistId) {
        if (!confirm('Bạn có chắc muốn xóa playlist này?')) return;
        fetch('/Playlists/DeletePlaylist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ playlistId }) })
            .then(r => r.json())
            .then(d => { if (d.success) { fetchUserPlaylists(); } else { alert(d.message || 'Lỗi'); } })
            .catch(e => { console.error(e); alert('Lỗi khi xóa playlist'); });
    }

    function showPlayer() { floatingPlayer.style.display = 'block'; }
    function hidePlayer() { floatingPlayer.style.display = 'none'; audioEl.pause(); isPlaying = false; updatePlayButton(); }

    function loadTrack(index) {
        const t = currentPlaylist[index];
        if (!t) return;
        // t.FileName is expected to be the file name stored in DB
        const file = t.FileName || t.file_name || t.FileName || '';
        const thumb = t.ThumbnailImage || t.thumbnail_image || '';
        const title = t.SongName || t.song_name || 'Không rõ';
        const artist = t.ArtistName || t.artist_name || '';

        fpTitle.textContent = title;
        fpArtist.textContent = artist;
        if (thumb) { fpThumbnail.src = '/Source/Musics-Image/' + thumb; fpThumbnail.style.display = 'block'; fpPlaceholder.style.display = 'none'; }
        else { fpThumbnail.style.display = 'none'; fpPlaceholder.style.display = 'block'; }

        // Update audio source
        if (file) {
            audioEl.src = '/Source/mp3/' + file;
        } else {
            audioEl.src = '';
            alert('Không có file bài hát');
        }
    }

    function playAudio() { audioEl.play(); isPlaying = true; updatePlayButton(); }
    function pauseAudio() { audioEl.pause(); isPlaying = false; updatePlayButton(); }
    function updatePlayButton() { fpPlayBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; }

    fpPlayBtn.addEventListener('click', () => { if (isPlaying) pauseAudio(); else playAudio(); });
    fpPrevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; loadTrack(currentIndex); playAudio(); } });
    fpNextBtn.addEventListener('click', () => { if (currentIndex < currentPlaylist.length - 1) { currentIndex++; loadTrack(currentIndex); playAudio(); } else { audioEl.pause(); } });
    fpCloseBtn.addEventListener('click', () => { hidePlayer(); });

    audioEl.addEventListener('timeupdate', () => {
        if (!audioEl.duration) return;
        const pct = (audioEl.currentTime / audioEl.duration) * 100;
        fpProgress.style.width = pct + '%';
    });
    audioEl.addEventListener('ended', () => {
        if (currentIndex < currentPlaylist.length - 1) { currentIndex++; loadTrack(currentIndex); playAudio(); }
        else { isPlaying = false; updatePlayButton(); }
    });

    document.getElementById('createPlaylistBtn').addEventListener('click', () => {
        const name = prompt('Tên playlist mới:');
        if (!name) return;
        fetch('/Playlists/CreateNewPlaylist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) })
            .then(r => r.json())
            .then(d => { if (d.success) fetchUserPlaylists(); else alert(d.message || 'Lỗi'); })
            .catch(e => { console.error(e); alert('Lỗi khi tạo playlist'); });
    });

    // Helpers
    function escapeHtml(s) { if (!s) return ''; return s.replace(/[&<>"']/g, function (c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }
    function escapeJs(s) { return (s||'').replace(/'/g, "\\'"); }

    // Initial load
    fetchUserPlaylists();
    
    // Check if playlistId was passed in query parameter
    @if (ViewBag.SelectedPlaylistId != null) {
        <text>
        // Auto-load the selected playlist
        setTimeout(() => {
            const playlistId = @ViewBag.SelectedPlaylistId;
            const playlistCard = document.querySelector(`[data-playlist-id="${playlistId}"]`);
            if (playlistCard) {
                playlistCard.click();
            }
        }, 500);
        </text>
    }
</script>
