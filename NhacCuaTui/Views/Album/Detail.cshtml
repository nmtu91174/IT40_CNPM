@using System.Collections
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Chi tiết Album";
    ArrayList album = ViewBag.Album ?? new ArrayList();
    ArrayList songs = ViewBag.Songs ?? new ArrayList();
}

<style>
    .album-detail-container {
        padding: 20px 0;
    }

    .album-header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 50px 30px;
        border-radius: 15px;
        margin-bottom: 40px;
        display: flex;
        gap: 50px;
        align-items: flex-start;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }

    .album-header-image {
        width: 280px;
        height: 280px;
        border-radius: 15px;
        object-fit: cover;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        flex-shrink: 0;
    }

    .album-header-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .album-header-info h1 {
        font-size: 44px;
        margin-bottom: 16px;
        line-height: 1.2;
        font-weight: 800;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .album-header-info .album-artist {
        font-size: 22px;
        margin-bottom: 25px;
        opacity: 0.95;
        font-weight: 500;
    }

    .album-meta {
        display: flex;
        gap: 40px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .album-meta-item {
        display: flex;
        flex-direction: column;
    }

    .album-meta-label {
        font-size: 13px;
        opacity: 0.85;
        margin-bottom: 8px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .album-meta-value {
        font-size: 22px;
        font-weight: 700;
    }

    .album-actions {
        display: flex;
        gap: 18px;
        margin-top: 25px;
        flex-wrap: wrap;
    }

    .btn-play-all {
        background: white;
        color: #667eea;
        padding: 14px 35px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.05rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-play-all:hover {
        transform: scale(1.08);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn-play-all:active {
        transform: scale(0.95);
    }

    .btn-add-to-playlist {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        padding: 14px 30px;
        border: 2px solid white;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.05rem;
    }

    .btn-add-to-playlist:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: scale(1.08);
    }

    .btn-add-to-playlist:active {
        transform: scale(0.95);
    }

    .songs-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .songs-section h2 {
        margin-bottom: 20px;
        color: #333;
    }

    .songs-table {
        width: 100%;
        border-collapse: collapse;
    }

    .songs-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #ddd;
    }

    .songs-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
    }

    .songs-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .songs-table tr:hover {
        background: #f8f9fa;
    }

    .song-name {
        font-weight: 500;
        color: #333;
    }

    .artist-name {
        color: #666;
        font-size: 13px;
    }

    .duration {
        color: #999;
        font-size: 13px;
    }

    .btn-play-song {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }

    .btn-play-song:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-play-song:active {
        transform: scale(0.95);
    }

    /* Floating Player */
    #floating-player {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 420px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 18px;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        user-select: none;
        cursor: move;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(450px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .player-header {
        background: rgba(0, 0, 0, 0.25);
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        cursor: grab;
    }

    .player-header:active {
        cursor: grabbing;
    }

    .player-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        letter-spacing: 0.5px;
    }

    .player-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 22px;
        cursor: pointer;
        padding: 5px 10px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        margin-left: 10px;
    }

    .player-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .player-content {
        padding: 24px 20px;
        text-align: center;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
    }

    .player-content:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .player-thumbnail {
        width: 140px;
        height: 140px;
        margin: 0 auto 18px;
        border-radius: 12px;
        object-fit: cover;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s;
    }

    .player-content:hover .player-thumbnail {
        transform: scale(1.05);
    }

    .player-song-name {
        font-size: 17px;
        font-weight: 700;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    .player-artist-name {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 16px;
    }

    .progress-container {
        margin: 20px 0;
        padding: 0 20px;
    }

    .progress-bar {
        width: 100%;
        height: 5px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 3px;
        cursor: pointer;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        background: white;
        border-radius: 3px;
        width: 0%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .time-display {
        font-size: 12px;
        opacity: 0.85;
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
    }

    .player-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 24px;
        padding: 0 20px 20px;
    }

    .player-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid white;
        color: white;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .player-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.15);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }

    .player-btn:active {
        transform: scale(0.90);
    }

    .player-btn.active {
        background: white;
        color: #667eea;
        border-color: white;
        box-shadow: 0 4px 14px rgba(255, 255, 255, 0.4);
    }

    audio {
        display: none;
    }

    @@media (max-width: 768px) {
        .album-header-section {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .album-meta {
            justify-content: center;
        }

        .album-actions {
            justify-content: center;
        }

        #floating-player {
            width: calc(100% - 20px);
            max-width: 380px;
        }
    }
</style>

<div class="container">
    <div class="album-detail-container">
        @if (album.Count >= 6)
        {
            int albumId = Convert.ToInt32(album[0]);
            string albumName = album[1]?.ToString() ?? "Không xác định";
            string artistNames = album[3]?.ToString() ?? "Không xác định";
            string releaseYear = album[4]?.ToString() ?? "N/A";
            string thumbnailImage = album[5]?.ToString() ?? "default.jpg";

            <div class="album-header-section">
                <img src="@Url.Content("~/Source/Albums-Image/" + thumbnailImage)" alt="@albumName" class="album-header-image" onerror="this.src='@Url.Content("~/Source/Albums-Image/" + thumbnailImage)'" onload="this.alt='@albumName'">
                <div class="album-header-info">
                    <h1>@albumName</h1>
                    <div class="album-artist">@artistNames</div>

                    <div class="album-meta">
                        <div class="album-meta-item">
                            <span class="album-meta-label">Năm phát hành</span>
                            <span class="album-meta-value">@releaseYear</span>
                        </div>
                        <div class="album-meta-item">
                            <span class="album-meta-label">Số bài hát</span>
                            <span class="album-meta-value">@songs.Count</span>
                        </div>
                    </div>

                    <div class="album-actions">
                        <button class="btn-play-all" onclick="playAllAlbum()">
                            <i class="fas fa-play"></i> Nghe Tất Cả
                        </button>
                        @if (Session["userId"] != null)
                        {
                            <button class="btn-add-to-playlist" onclick="openAlbumPlaylistPopup()">
                                <i class="fas fa-plus"></i> Thêm vào Playlist
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="songs-section">
                <h2><i class="fas fa-list"></i> Danh sách bài hát</h2>

                @if (songs.Count > 0)
                {
                    <table class="songs-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Thứ tự</th>
                                <th>Bài Hát</th>
                                <th style="width: 150px;">Nghệ Sĩ</th>
                                <th style="width: 80px;">Thời lượng</th>
                                <th style="width: 80px;" class="text-center">Phát</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int songIndex = 1;
                            }
                            @foreach (ArrayList song in songs)
                            {
                                if (song.Count >= 5)
                                {
                                    int songId = Convert.ToInt32(song[0]);
                                    string songName = song[1]?.ToString() ?? "Không xác định";
                                    string artistName = song[2]?.ToString() ?? "Không xác định";
                                    string duration = song[3]?.ToString() ?? "0:00";
                                    string fileName = song[4]?.ToString() ?? "";

                                    <tr class="song-row">
                                        <td>@songIndex</td>
                                        <td>
                                            <a href="/PlayMusic/Index?id=@songId" style="text-decoration: none; color: inherit;">
                                                <div class="song-name">@songName</div>
                                                <div class="artist-name">@artistName</div>
                                            </a>
                                        </td>
                                        <td>@artistName</td>
                                        <td class="duration">@duration</td>
                                        <td class="text-center">
                                            <button class="btn-play-song" onclick="playSingleSong(@songId)" title="Phát bài hát">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    songIndex++;
                                }
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p><i class="fas fa-music"></i> Album này chưa có bài hát nào</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Floating Player -->
<div id="floating-player">
    <div class="player-header">
        <h3>Đang phát</h3>
        <button class="player-close" onclick="closeAlbumPlayer()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="player-content" onclick="openCurrentSongPage()">
        <img id="player-thumbnail" src="" alt="Album" class="player-thumbnail">
        <div class="player-song-name" id="player-song-name">Chưa chọn bài hát</div>
        <div class="player-artist-name" id="player-artist-name">Không xác định</div>
    </div>

    <div style="padding: 0 20px;">
        <div class="progress-container">
            <div class="progress-bar" onclick="seekAlbumAudio(event)">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="time-display">
                <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
            </div>
        </div>

        <div class="player-controls">
            <button class="player-btn" onclick="prevAlbumTrack()" title="Bài trước">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="player-btn active" id="play-pause-btn" onclick="toggleAlbumPlayPause()" title="Phát/Tạm dừng">
                <i class="fas fa-pause"></i>
            </button>
            <button class="player-btn" onclick="nextAlbumTrack()" title="Bài tiếp theo">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
    </div>
</div>

<audio id="album-audio"></audio>

<script>
    let albumTracks = [];
    let currentTrackIndex = 0;
    let isAlbumPlaying = false;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    // Make player draggable
    const playerHeader = document.querySelector('.player-header');
    const floatingPlayer = document.getElementById('floating-player');

    if (playerHeader) {
        playerHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = floatingPlayer.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                floatingPlayer.style.right = 'auto';
                floatingPlayer.style.bottom = 'auto';
                floatingPlayer.style.left = (e.clientX - dragOffsetX) + 'px';
                floatingPlayer.style.top = (e.clientY - dragOffsetY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    function playAllAlbum() {
        albumTracks = [];
        const rows = document.querySelectorAll('.song-row');
        
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                const songLink = cells[1].querySelector('a');
                if (songLink) {
                    const href = songLink.getAttribute('href');
                    const id = href ? new URLSearchParams(href.split('?')[1]).get('id') : null;
                    const songName = cells[1].querySelector('.song-name')?.textContent || 'Không xác định';
                    const artistName = cells[2]?.textContent || 'Không xác định';
                    
                    if (id) {
                        albumTracks.push({ SongId: id, SongName: songName, ArtistName: artistName });
                    }
                }
            }
        });

        if (albumTracks.length > 0) {
            currentTrackIndex = 0;
            document.getElementById('floating-player').style.display = 'block';
            loadAlbumTrack(0);
            playAlbumAudio();
        }
    }

    function playSingleSong(songId) {
        albumTracks = [];
        const rows = document.querySelectorAll('.song-row');
        let foundIndex = 0;

        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                const songLink = cells[1].querySelector('a');
                if (songLink) {
                    const href = songLink.getAttribute('href');
                    const id = href ? new URLSearchParams(href.split('?')[1]).get('id') : null;
                    const songName = cells[1].querySelector('.song-name')?.textContent || 'Không xác định';
                    const artistName = cells[2]?.textContent || 'Không xác định';
                    
                    if (id) {
                        albumTracks.push({ SongId: id, SongName: songName, ArtistName: artistName });
                        if (id === songId.toString()) foundIndex = albumTracks.length - 1;
                    }
                }
            }
        });

        if (albumTracks.length > 0) {
            currentTrackIndex = foundIndex;
            document.getElementById('floating-player').style.display = 'block';
            loadAlbumTrack(foundIndex);
            playAlbumAudio();
        }
    }

    function loadAlbumTrack(index, autoplay = false) {
        if (index < 0 || index >= albumTracks.length) return;

        const track = albumTracks[index];
        const songId = track.SongId;

        fetch(`/PlayMusic/GetSongDetails?id=${songId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('player-song-name').textContent = track.SongName;
                    document.getElementById('player-artist-name').textContent = track.ArtistName;
                    document.getElementById('player-thumbnail').src = `@Url.Content("~/Source/Musics-Image/")` + data.thumbnail;

                    const audio = document.getElementById('album-audio');
                    audio.src = `@Url.Content("~/Source/mp3/")` + data.filename;
                    
                    audio.oncanplay = () => {
                        if (autoplay) {
                            audio.play().catch(error => console.log('Play prevented'));
                        }
                    };
                    
                    audio.onloadedmetadata = () => {
                        document.getElementById('total-time').textContent = formatTime(audio.duration);
                        if (autoplay) {
                            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
                            isAlbumPlaying = true;
                        }
                    };
                }
            })
            .catch(error => console.error('Error loading track:', error));
    }

    function playAlbumAudio() {
        const audio = document.getElementById('album-audio');
        audio.play();
        document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
        isAlbumPlaying = true;
    }

    function pauseAlbumAudio() {
        const audio = document.getElementById('album-audio');
        audio.pause();
        document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
        isAlbumPlaying = false;
    }

    function toggleAlbumPlayPause() {
        if (isAlbumPlaying) {
            pauseAlbumAudio();
        } else {
            playAlbumAudio();
        }
    }

    function nextAlbumTrack() {
        if (currentTrackIndex < albumTracks.length - 1) {
            currentTrackIndex++;
            loadAlbumTrack(currentTrackIndex, true);  // true = autoplay
        }
    }

    function prevAlbumTrack() {
        if (currentTrackIndex > 0) {
            currentTrackIndex--;
            loadAlbumTrack(currentTrackIndex, true);  // true = autoplay
        }
    }

    function seekAlbumAudio(event) {
        const progressBar = event.currentTarget;
        const rect = progressBar.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        const audio = document.getElementById('album-audio');
        audio.currentTime = percent * audio.duration;
    }

    function closeAlbumPlayer() {
        document.getElementById('floating-player').style.display = 'none';
    }

    function openCurrentSongPage() {
        if (albumTracks.length > 0) {
            const songId = albumTracks[currentTrackIndex].SongId;
            window.location.href = `/PlayMusic/Index?id=${songId}`;
        }
    }

    function openAlbumPlaylistPopup() {
        const albumId = @ViewBag.AlbumId;
        const albumName = '@(album.Count > 1 ? album[1] : "Album")';
        
        fetch(`/Playlists/GetUserPlaylists?songId=0`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message);
                    return;
                }

                const playlistContainer = document.getElementById("user-playlists");
                playlistContainer.innerHTML = "";
                
                data.playlists.forEach(playlist => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.textContent = playlist.name;

                    const addButton = document.createElement("button");
                    addButton.className = "btn btn-sm btn-success";
                    addButton.textContent = "Thêm";
                    addButton.onclick = () => addAlbumToPlaylist(albumId, playlist.id);

                    li.appendChild(addButton);
                    playlistContainer.appendChild(li);
                });

                document.getElementById("song-title").textContent = `Thêm album "${albumName}" vào playlist`;
                const modal = new bootstrap.Modal(document.getElementById("playlistModal"));
                modal.show();
            });
    }

    function addAlbumToPlaylist(albumId, playlistId) {
        fetch(`/Album/AddAlbumToPlaylist`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ albumId, playlistId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Album đã được thêm vào playlist!");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("playlistModal"));
                    modal.hide();
                } else {
                    alert("Lỗi: " + data.message);
                }
            });
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    document.getElementById('album-audio').addEventListener('timeupdate', function () {
        const percent = (this.currentTime / this.duration) * 100;
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('current-time').textContent = formatTime(this.currentTime);
    });

    document.getElementById('album-audio').addEventListener('ended', function () {
        nextAlbumTrack();
    });
</script>
