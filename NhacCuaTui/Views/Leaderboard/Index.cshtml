@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var rows = ViewBag.TopSongs as System.Collections.ArrayList;
}

<style>
    .leaderboard-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 0;
        margin-bottom: 40px;
        color: white;
    }
    .leaderboard-title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }
    .leaderboard-subtitle {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.9;
    }
    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
    }
    .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
    .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%); }
    .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
    .rank-default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .song-row {
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }
    .song-row:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .song-name {
        font-weight: 600;
        color: #333;
        font-size: 1.05rem;
    }
    .artist-name {
        color: #666;
        font-size: 0.95rem;
    }
    .stat-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .views-badge {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    .likes-badge {
        background-color: #fce4ec;
        color: #c2185b;
    }
    .date-badge {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    /* ===== FLOATING PLAYER STYLES ===== */
    .floating-player {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 380px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        color: white;
        font-family: 'Arial', sans-serif;
        z-index: 1000;
        overflow: hidden;
    }

    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: rgba(0, 0, 0, 0.25);
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
    }

    .player-title {
        font-weight: bold;
        font-size: 16px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
        line-height: 1;
        transition: color 0.2s;
    }

    .close-btn:hover {
        color: #ffeb3b;
    }

    .player-content {
        display: flex;
        gap: 16px;
        padding: 16px;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: background 0.2s;
    }

    .player-content:hover {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
    }

    .player-thumbnail {
        width: 120px;
        height: 120px;
        border-radius: 12px;
        object-fit: cover;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
    }

    .player-content:hover .player-thumbnail {
        transform: scale(1.05);
    }

    .player-info {
        flex: 1;
        min-width: 0;
        text-align: center;
        width: 100%;
    }

    .player-song-name {
        font-weight: bold;
        font-size: 18px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-bottom: 6px;
    }

    .player-artist-name {
        font-size: 14px;
        opacity: 0.95;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .player-progress {
        height: 4px;
        background: rgba(255, 255, 255, 0.25);
        cursor: pointer;
        margin: 12px 0 0 0;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ffeb3b, #ffc107);
        transition: width 0.1s linear;
        box-shadow: 0 0 8px rgba(255, 235, 59, 0.5);
    }

    .player-time {
        font-size: 13px;
        padding: 8px 16px;
        text-align: center;
        opacity: 0.9;
        font-weight: 500;
    }

    .player-controls {
        display: flex;
        justify-content: center;
        gap: 16px;
        padding: 16px;
        border-top: 2px solid rgba(255, 255, 255, 0.15);
    }

    .control-btn {
        background: rgba(255, 255, 255, 0.25);
        border: 2px solid rgba(255, 255, 255, 0.4);
        color: white;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-weight: bold;
    }

    .control-btn:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: scale(1.12);
        box-shadow: 0 4px 12px rgba(255, 235, 59, 0.3);
    }

    .control-btn:active {
        transform: scale(0.95);
    }

    /* ===== PLAY BUTTON STYLES ===== */
    .btn-play-song {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
    }

    .btn-play-song:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-play-song:active {
        transform: scale(0.95);
    }

    /* Card-style Leaderboard */
    .leaderboard-cards-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
    }

    .card-song-item {
        background: white;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 5px solid #667eea;
    }

    .card-song-item:hover {
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
        border-left-color: #764ba2;
    }

    .card-rank-badge {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 1.3rem;
        color: white;
    }

    .card-rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
    .card-rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%); }
    .card-rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
    .card-rank-default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

    .card-song-info {
        flex: 1;
        min-width: 0;
    }

    .card-song-title {
        font-weight: 600;
        font-size: 1rem;
        color: #222;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .card-song-title a {
        color: #222;
        text-decoration: none;
    }

    .card-song-title a:hover {
        color: #667eea;
    }

    .card-song-artist {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .card-song-artist a {
        color: #666;
        text-decoration: none;
    }

    .card-song-artist a:hover {
        color: #764ba2;
    }

    .card-stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end;
        align-items: center;
    }

    .card-stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        padding: 6px 10px;
        border-radius: 8px;
        background: #f5f5f5;
        color: #555;
    }

    .card-stat-item.views { background: #e3f2fd; color: #1976d2; }
    .card-stat-item.likes { background: #fce4ec; color: #c2185b; }
    .card-stat-item.date { background: #f3e5f5; color: #7b1fa2; }

    .card-play-btn {
        flex-shrink: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    .card-play-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .card-play-btn:active {
        transform: scale(0.95);
    }

    @@media (max-width: 768px) {
        .card-song-item {
            flex-wrap: wrap;
            padding: 12px;
        }

        .card-stats {
            width: 100%;
            justify-content: space-between;
            order: 4;
        }

        .card-stat-item {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .card-play-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
    }
</style>

<div class="leaderboard-container">
    <div class="container">
        <h1 class="leaderboard-title">🏆 Bảng Xếp Hạng</h1>
        <p class="leaderboard-subtitle">Top 10 bài hát được nghe nhiều nhất</p>
    </div>
</div>

<div class="container mt-4 mb-5">
    @if (rows == null || rows.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <h4>Chưa có dữ liệu</h4>
            <p class="text-muted">Vui lòng quay lại sau.</p>
        </div>
    }
    else
    {
        <div class="row mb-3">
            <div class="col-12">
                <button id="play-all-btn" class="btn btn-primary btn-lg" onclick="playAllLeaderboard()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; font-size: 1.1rem;">
                    <i class="fas fa-play"></i> Nghe Tất Cả (Top 10)
                </button>
            </div>
        </div>

        <div class="leaderboard-cards-container">
            @foreach (var r in rows)
            {
                var row = r as System.Collections.ArrayList;
                if (row == null) { continue; }
                
                var rank = row.Count > 0 ? row[0]?.ToString() ?? "" : "";
                var songName = row.Count > 2 ? row[2]?.ToString() ?? "" : "";
                var artist = row.Count > 7 ? row[7]?.ToString() ?? "" : "";
                var views = row.Count > 3 ? row[3]?.ToString() ?? "0" : "0";
                var likes = row.Count > 4 ? row[4]?.ToString() ?? "0" : "0";
                var releaseDate = row.Count > 5 ? row[5]?.ToString() ?? "" : "";
                
                var rankNum = 0;
                int.TryParse(rank, out rankNum);
                var rankClass = rankNum == 1 ? "card-rank-1" : rankNum == 2 ? "card-rank-2" : rankNum == 3 ? "card-rank-3" : "card-rank-default";
                
                <div class="card-song-item song-row" data-song-id="@(row.Count > 1 ? row[1] : "")" data-song-name="@songName" data-artist-name="@artist">
                    <div class="card-rank-badge @rankClass">@rank</div>
                    
                    <div class="card-song-info">
                        <div class="card-song-title">
                            <a href="/PlayMusic/Index?id=@(row.Count > 1 ? row[1] : "")">@songName</a>
                        </div>
                        <div class="card-song-artist">
                            <a href="/Artist/Index">@artist</a>
                        </div>
                    </div>

                    <div class="card-stats">
                        <div class="card-stat-item views">
                            <i class="fas fa-eye"></i> @views
                        </div>
                        <div class="card-stat-item likes">
                            <i class="fas fa-heart"></i> @likes
                        </div>
                        <div class="card-stat-item date">
                            <i class="fas fa-calendar"></i> @releaseDate
                        </div>
                    </div>

                    <button class="card-play-btn" onclick="playSingleSong(@(row.Count > 1 ? row[1] : '0'))" title="Phát bài hát này">
                        <i class="fas fa-play"></i> Phát
                    </button>
                </div>
            }
        </div>
    }
</div>

<!-- Floating Audio Player for Leaderboard -->
<div id="floating-player" class="floating-player" style="display: none;">
    <div class="player-header">
        <span id="fp-title" class="player-title">Đang chọn bài hát...</span>
        <button id="close-player-btn" class="close-btn" onclick="closeLeaderboardPlayer()">×</button>
    </div>
    <div class="player-content" id="player-content-clickable" style="cursor: pointer;">
        <img id="fp-thumbnail" src="" alt="Album Art" class="player-thumbnail">
        <div class="player-info">
            <div id="fp-song-name" class="player-song-name">Tên bài hát</div>
            <div id="fp-artist-name" class="player-artist-name">Nghệ sỹ</div>
        </div>
    </div>
    <div class="player-progress">
        <div id="fp-progress" class="progress-bar" style="width: 0%"></div>
    </div>
    <div class="player-time">
        <span id="fp-current-time">0:00</span> / <span id="fp-duration">0:00</span>
    </div>
    <div class="player-controls">
        <button id="prev-btn" class="control-btn" onclick="prevLeaderboardTrack()" title="Bài trước">⏮</button>
        <button id="play-btn" class="control-btn" onclick="toggleLeaderboardPlayPause()" title="Phát">▶</button>
        <button id="next-btn" class="control-btn" onclick="nextLeaderboardTrack()" title="Bài tiếp">⏭</button>
    </div>
    <audio id="fp-audio"></audio>
</div>

<script>
    // Biến toàn cục cho player
    let leaderboardTracks = [];
    let currentTrackIndex = 0;
    let isPlaying = false;

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function playAllLeaderboard() {
        // Lấy tất cả bài hát từ bảng
        leaderboardTracks = [];
        const rows = document.querySelectorAll('.song-row');
        
        rows.forEach(row => {
            const songId = row.dataset.songId;
            const songName = row.dataset.songName;
            const artistName = row.dataset.artistName;
            
            if (songId && songName && artistName) {
                leaderboardTracks.push({
                    SongId: songId,
                    SongName: songName,
                    ArtistName: artistName
                });
            }
        });

        if (leaderboardTracks.length > 0) {
            currentTrackIndex = 0;
            document.getElementById('floating-player').style.display = 'block';
            loadLeaderboardTrack(0);
            playLeaderboardAudio();
        } else {
            alert('Không thể tải danh sách bài hát');
        }
    }

    function playSingleSong(songId) {
        // Phát một bài hát riêng lẻ
        if (!songId || songId === '0') {
            alert('Không thể phát bài hát này');
            return;
        }

        // Tìm bài hát trong danh sách leaderboard
        const rows = document.querySelectorAll('.song-row');
        leaderboardTracks = [];
        let foundIndex = 0;

        rows.forEach((row, index) => {
            const id = row.dataset.songId;
            const songName = row.dataset.songName;
            const artistName = row.dataset.artistName;
            
            if (id && songName && artistName) {
                leaderboardTracks.push({
                    SongId: id,
                    SongName: songName,
                    ArtistName: artistName
                });

                if (id === songId.toString()) {
                    foundIndex = leaderboardTracks.length - 1;
                }
            }
        });

        if (leaderboardTracks.length > 0) {
            currentTrackIndex = foundIndex;
            document.getElementById('floating-player').style.display = 'block';
            loadLeaderboardTrack(foundIndex);
            playLeaderboardAudio();
        } else {
            alert('Không thể tải bài hát');
        }
    }

    function loadLeaderboardTrack(index, autoplay = false) {
        if (index < 0 || index >= leaderboardTracks.length) return;
        currentTrackIndex = index;
        const track = leaderboardTracks[index];
        
        const fpTitle = document.getElementById('fp-title');
        const fpSongName = document.getElementById('fp-song-name');
        const fpArtistName = document.getElementById('fp-artist-name');
        const fpThumbnail = document.getElementById('fp-thumbnail');
        const audioEl = document.getElementById('fp-audio');

        fpTitle.textContent = escapeHtml(track.SongName);
        fpSongName.textContent = escapeHtml(track.SongName);
        fpArtistName.textContent = escapeHtml(track.ArtistName);
        
        // Pause audio trước khi load bài mới
        audioEl.pause();
        audioEl.currentTime = 0;
        
        // Fetch song details
        fetch('/PlayMusic/GetSongDetails?id=' + track.SongId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.thumbnail) {
                        fpThumbnail.src = '/Source/Musics-Image/' + encodeURIComponent(data.thumbnail);
                    } else {
                        fpThumbnail.src = '/assets/images/default-album.png';
                    }
                    if (data.filename) {
                        audioEl.src = '/Source/mp3/' + encodeURIComponent(data.filename);
                        
                        // Setup event listener để play khi audio ready
                        if (autoplay) {
                            audioEl.oncanplay = () => {
                                audioEl.play().catch(error => console.log('Play prevented:', error));
                                document.getElementById('play-btn').textContent = '⏸';
                                isPlaying = true;
                            };
                        }
                    }
                } else {
                    console.error('Song details error:', data.message);
                }
            })
            .catch(error => console.error('Error loading song details:', error));
    }

    function playLeaderboardAudio() {
        const audioEl = document.getElementById('fp-audio');
        audioEl.play();
        document.getElementById('play-btn').textContent = '⏸';
        isPlaying = true;
    }

    function pauseLeaderboardAudio() {
        const audioEl = document.getElementById('fp-audio');
        audioEl.pause();
        document.getElementById('play-btn').textContent = '▶';
        isPlaying = false;
    }

    function toggleLeaderboardPlayPause() {
        if (isPlaying) {
            pauseLeaderboardAudio();
        } else {
            playLeaderboardAudio();
        }
    }

    function nextLeaderboardTrack() {
        if (currentTrackIndex < leaderboardTracks.length - 1) {
            loadLeaderboardTrack(currentTrackIndex + 1, true);
        }
    }

    function prevLeaderboardTrack() {
        if (currentTrackIndex > 0) {
            loadLeaderboardTrack(currentTrackIndex - 1, true);
        }
    }

    function closeLeaderboardPlayer() {
        const audioEl = document.getElementById('fp-audio');
        audioEl.pause();
        document.getElementById('floating-player').style.display = 'none';
        isPlaying = false;
    }

    function openCurrentSongPage() {
        if (leaderboardTracks.length > 0 && currentTrackIndex >= 0 && currentTrackIndex < leaderboardTracks.length) {
            const songId = leaderboardTracks[currentTrackIndex].SongId;
            if (songId) {
                window.location.href = '/PlayMusic/Index?id=' + songId;
            }
        }
    }

    // Audio event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const audioEl = document.getElementById('fp-audio');
        const playerContent = document.getElementById('player-content-clickable');
        
        // Click to open song page
        if (playerContent) {
            playerContent.addEventListener('click', function() {
                openCurrentSongPage();
            });
        }
        
        audioEl.addEventListener('timeupdate', function() {
            if (audioEl.duration) {
                const progress = (audioEl.currentTime / audioEl.duration) * 100;
                document.getElementById('fp-progress').style.width = progress + '%';
                
                const currentMin = Math.floor(audioEl.currentTime / 60);
                const currentSec = Math.floor(audioEl.currentTime % 60);
                const durationMin = Math.floor(audioEl.duration / 60);
                const durationSec = Math.floor(audioEl.duration % 60);
                
                document.getElementById('fp-current-time').textContent = 
                    currentMin + ':' + (currentSec < 10 ? '0' : '') + currentSec;
                document.getElementById('fp-duration').textContent = 
                    durationMin + ':' + (durationSec < 10 ? '0' : '') + durationSec;
            }
        });

        audioEl.addEventListener('ended', function() {
            if (currentTrackIndex < leaderboardTracks.length - 1) {
                nextLeaderboardTrack();
            }
        });
    });
</script>
